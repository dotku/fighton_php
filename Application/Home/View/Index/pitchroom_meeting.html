<!DOCTYPE html>
<html>
<head>
    <title>密谈 - <?php echo C('web_title'); ?></title>
    <include file="Common:head.meta"/>
    <meta content='1 day' name='revisit-after'>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <link rel="shortcut icon" href="favicon.ico?v=5" type="image/x-icon">
    <!-- Fonts -->
    <!--link href='http://fonts.googleapis.com/css?family=Roboto:400,100,300,400italic,300italic,100italic,700italic,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'-->
    <!-- Styles -->
    <include file="Common:head.style"/>
    <!-- HTML5 fallbacks -->
    <!--[if lt IE 9]>
    <script src="__PUBLIC__/javascripts/html5shiv.js" type="text/javascript"></script>
    <script src="__PUBLIC__/javascripts/respond.min.js" type="text/javascript"></script>
    <![endif]-->
    <include file="Common:head.script"/>
    <script src="__PUBLIC__/javascripts/jquery.min.js" type="text/javascript"></script>
    <script src="__PUBLIC__/lib/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="__PUBLIC__/lib/agora-web-sdk/v0.5.1/vendor/socket.io.js"></script>
    <script src="__PUBLIC__/lib/agora-web-sdk/v0.5.1/vendor/adapter.js"></script>
    <script src="__PUBLIC__/lib/agora-web-sdk/v0.5.1/AgoraSDK.js"></script>
    <style>
        body, p, h1, 
        #navigation li a, #filter-trigger, #filters {font-family: "微软雅黑", Arial, sans-serif;}
        @media (max-width: 780px) {
            #navigation li {
                border-bottom: solid 1px #eee;
            }
        }
        .main{
            padding: 0px;
            height: 100%;
        }
        .full {
            height: 100%;
        }
        .main-menu {
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .trigger {
          position: absolute;
          right: 10px;
          top: 7px;
          height: 35px;
          width: 30px;
          padding-top: 8px;
          cursor: pointer;
        }
        .bar {
          background: #fff;
        }
    </style>
<script>
    var G = {};
    G.Agora_root = "__ROOT__/Public/lib/agora-api";
</script>
</head>

<body>
<div class="full">
    <div class="main col-md-9">
         <div id="video_remote" style="position: absolute; top: 0px; width:100%; height: 100%; background-color: black">
            <div id="agora_remote" style="height: 100%; width: 100%"></div>
        </div>
        <div class="main-menu">
            <a class="btn btn-warning dropdown-toggle" data-toggle="dropdown" style="font-size: 20px;">三 <span class="caret"></span></a>
            <ul class="dropdown-menu">
                <li><a href="{:U('/user_profile')}">修改昵称</a></li>
                <li><a href="{:U('/pitchroom_leave')}">回房间列表</a></li>
                <li role="separator" class="divider"></li>
                <li><a href="{:U('/user_signout')}">退出</a></li>
            </ul>
        </div>
        <?php if ($_SESSION['login']['id'] == $_SESSION['pitchroom']['hostid']) {?>
        <div class="main-btnbar col-md-6 col-md-offset-3 text-center" style="position: absolute; bottom: 40px;">
            <!-- unkown parsing bug {:U()} -->
            <a class="btn btn-primary" href="{:U('/pitchroom_start')}">开始</a>
            <a class="btn btn-primary" href="{:U('/pitchroom_invite')}">邀请</a>
            <a class="btn btn-primary">3</a>
            <a class="btn btn-primary">4</a>
            <a class="btn btn-danger" href="{:U('/pitchroom_leave')}">退出</a>
            
        </div>
        <?php } ?>
        <div class="mssage" style="position: relative; top: 100px;">
            <?php 
            //var_dump($_SESSION);
        ?>
        </div>
        

    </div>
    <div class="sidebar col-md-3" style="padding: 0px;">
        <div id="video" style="position: absolute; top: 0px; width:100%; height: 240px; background-color: black">
            <div id="agora_local" style="height: 100%; width: 100%"></div>
        </div>
        侧边栏
    <div>
</div>
<input id="key" type="text" value="ddab61fe6bee4e97b2a61a8774623e01" size="36" type="hidden">
<input id="channel" type="text" value="{$_SESSION['pitchroom']['id']}" size="4" type="hidden">
<script>
$(function(){
    $(window).resize(function(){
        $(".main").height($(window).height());
    })
})
</script>
<?php if ($output['pitchroom_status'] == 1) { ?>
<script>
$(function(){
    join();
})
</script>
<?php } else {?>
<?php 
    //var_dump($output); 
?>
<?php } ?>
<script language="javascript">

  var client, localStream;

  function bindPlayer(stream) {
    console.log("bindPlayer");
    stream.showing= false;
    stream.show = function (elementID, options) {
      if (stream.hasVideo() || stream.hasScreen()) {
        if (elementID !== undefined) {
          stream.player = new Agora.VideoPlayer({
            id: stream.getId(),
            stream: stream,
            elementID: elementID,
            options: options});
          stream.showing = true;
        }
      } else if (stream.hasAudio()) {
        stream.player = new Agora.AudioPlayer({
          id: stream.getId(),
          stream: stream,
          elementID: elementID,
          options: options});
        stream.showing = true;
      }
    };
    stream.play = stream.show;
  }

  function join() {
    document.getElementById("video").disabled = false;
    console.log('Joining channel ' + key.value + ' : ' + channel.value);
    client = Agora.Client({
    });
    client.init(key.value, channel.value, function (err) {
      console.log("Connecting to vocs failed", err);
    });
    client.on('client-initialized', function (evt) {
      var data = evt.attr;
      console.log("Connecting vocs done", JSON.stringify(data['vos_list'][0]));
      var uid = data.uid;
      console.log("Connecting to vos gateway");
      client.connect(function (err) {
        console.log("Join vos gateway failed", err);
      });
      client.on('client-connected', function (evt) {
        console.log("Join vos gateway successfully");
        console.log("Login to vos");
        client.join(function (msg) {
          console.log(msg);
        });
        client.on('join-success', function () {
          console.log("Join vos successfully");
          localStream = Agora.Stream({
            streamID: uid, 
            audio: true, 
            video: document.getElementById("video").checked,
            data: false, screen: false});
          //if (document.getElementById("video").checked) {
            // 总是要设置视频
            localStream.setVideo("sif", [15, 60]);
          //}
          localStream.init(function (err) {
            console.log("Media access failed", err);
          });
          localStream.on('access-accepted', function () {
            bindPlayer(localStream);
            console.log("Media access successfully: streamId = ", localStream.getId());
            localStream.show('agora_local');
            console.log("Publish local stream");
            client.publish(localStream, function (err) {
              console.log("Publish local stream error: " + err);
            });
            client.on('stream-published', function (evt) {
              var stream = evt.stream;
              console.log("Catch stream-published event");
            });
          });
        });
        client.on('stream-added', function (evt) {
          console.log("Catch stream-added event");
          var stream = evt.stream;
          console.log("Subscribe ", stream);
          bindPlayer(stream);
          client.subscribe(stream, function (err) {
            console.log("Subscribe failed", err);
          });
        });
        client.on('stream-subscribed', function (evt) {
          console.log("Catch stream-subscribed event");
          var stream = evt.stream;
          if ($('div#video_remote #agora_remote'+stream.getId()).length === 0) {
            $('div#video_remote').html('<div id="agora_remote'+stream.getId()+'" style="width:320px;height:240px"></div>');
          }
          stream.show('agora_remote'+stream.getId());
        });
      });
    });
  }

  function unpublish() {
    client.unpublish(localStream, function (err) {
      console.log("unpublish error", err);
    });
  }

  function leave() {
    console.log("leave");
    client.leave();
  }
</script>
</body>
</html>
